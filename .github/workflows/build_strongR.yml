name: Build strongR-frida

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build_strongR.yml'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        local-cache: false
      id: setup-ndk
        
    - name: Verify NDK version
      run: |
        # 获取 NDK 路径
        if [ -n "${{ steps.setup-ndk.outputs.ndk-path }}" ]; then
          export ANDROID_NDK_ROOT="${{ steps.setup-ndk.outputs.ndk-path }}"
        elif [ -n "$ANDROID_NDK_ROOT" ]; then
          export ANDROID_NDK_ROOT="$ANDROID_NDK_ROOT"
        else
          # 尝试从环境变量获取
          export ANDROID_NDK_ROOT=$(find $HOME -name "android-ndk-r25*" -type d 2>/dev/null | head -1)
        fi
        
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        
        if [ -z "$ANDROID_NDK_ROOT" ] || [ ! -d "$ANDROID_NDK_ROOT" ]; then
          echo "Error: ANDROID_NDK_ROOT is not set or invalid"
          exit 1
        fi
        
        if [ -f "$ANDROID_NDK_ROOT/source.properties" ]; then
          NDK_VERSION=$(grep "Pkg.Revision" "$ANDROID_NDK_ROOT/source.properties" | cut -d '=' -f 2 | tr -d ' ')
          echo "Detected NDK version: $NDK_VERSION"
          if [[ ! "$NDK_VERSION" =~ ^25\. ]]; then
            echo "Error: NDK version must be r25.x, but found r${NDK_VERSION}"
            exit 1
          fi
        else
          echo "Warning: Cannot verify NDK version, but continuing..."
        fi
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build gcc-multilib \
          g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev \
          python3-requests python3-setuptools python3-dev python3-pip git
        sudo gem install fpm -v 1.11.0 --no-document
        pip3 install lief graphlib
        
    - name: Clone Frida
      run: |
        git clone --recurse-submodules https://github.com/frida/frida.git
        cd frida
        git checkout 17.5.2
        
    - name: Clone strongR patches
      run: |
        git clone https://github.com/AAAA-Project/Patchs.git
        
    - name: Configure Git
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "GitHub Actions"
        
    - name: Apply patches
      run: |
        cd frida/subprojects/frida-core
        
        # 检查补丁目录
        if [ ! -d "../../../Patchs/strongR-frida/frida-core" ]; then
          echo "Error: Patch directory not found"
          ls -la ../../../Patchs/strongR-frida/ || true
          exit 1
        fi
        
        # 按顺序应用补丁
        PATCHES=(
          "../../../Patchs/strongR-frida/frida-core/0001-string_frida_rpc.patch"
          "../../../Patchs/strongR-frida/frida-core/0002-io_re_frida_server.patch"
          "../../../Patchs/strongR-frida/frida-core/0003-pipe_linjector.patch"
          "../../../Patchs/strongR-frida/frida-core/0004-io_frida_agent_so.patch"
          "../../../Patchs/strongR-frida/frida-core/0005-symbol_frida_agent_main.patch"
          "../../../Patchs/strongR-frida/frida-core/0006-thread_gum_js_loop.patch"
          "../../../Patchs/strongR-frida/frida-core/0007-thread_gmain.patch"
          "../../../Patchs/strongR-frida/frida-core/0008-protocol_unexpected_command.patch"
        )
        
        for patch in "${PATCHES[@]}"; do
          if [ -f "$patch" ]; then
            echo "Applying: $(basename $patch)"
            git am "$patch" 2>&1 || {
              echo "git am failed, trying git apply..."
              git am --abort 2>/dev/null || true
              git apply "$patch" 2>&1 || {
                echo "Warning: Failed to apply $(basename $patch), but continuing..."
                # 对于某些补丁，失败可能是正常的（如果已经应用过）
              }
            }
          else
            echo "Warning: Patch file not found: $patch"
          fi
        done
        
        # 检查是否有 frida-gum 补丁需要应用
        if [ -d "../../../Patchs/strongR-frida/frida-gum" ]; then
          echo "Applying frida-gum patches..."
          cd ../../frida-gum/gum
          for patch in ../../../../Patchs/strongR-frida/frida-gum/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying: $(basename $patch)"
              git am "$patch" 2>&1 || {
                git am --abort 2>/dev/null || true
                git apply "$patch" 2>&1 || {
                  echo "Warning: Failed to apply $(basename $patch)"
                }
              }
            fi
          done
        fi
        
    - name: Build ARM64
      run: |
        cd frida
        
        # 确保 NDK 环境变量已设置
        if [ -z "$ANDROID_NDK_ROOT" ]; then
          echo "Error: ANDROID_NDK_ROOT is not set"
          exit 1
        fi
        
        echo "Using NDK: $ANDROID_NDK_ROOT"
        export ANDROID_NDK_ROOT="$ANDROID_NDK_ROOT"
        
        # 验证 NDK 版本
        if [ -f "$ANDROID_NDK_ROOT/source.properties" ]; then
          NDK_VERSION=$(grep "Pkg.Revision" "$ANDROID_NDK_ROOT/source.properties" | cut -d '=' -f 2 | tr -d ' ')
          echo "NDK version: $NDK_VERSION"
          if [[ ! "$NDK_VERSION" =~ ^25\. ]]; then
            echo "Error: NDK version must be r25.x, but found r${NDK_VERSION}"
            exit 1
          fi
        fi
        
        ./configure --host=android-arm64 --enable-portal
        make -j$(nproc)
        
    - name: Package artifacts
      run: |
        cd frida
        
        # 查找编译产物（Frida 17.5.2 的路径结构）
        echo "Searching for build artifacts..."
        
        # 尝试多个可能的路径
        FRIDA_SERVER=""
        FRIDA_INJECT=""
        FRIDA_GADGET=""
        
        # 路径1: build/frida-android-arm64/bin/
        if [ -f "build/frida-android-arm64/bin/frida-server" ]; then
          FRIDA_SERVER="build/frida-android-arm64/bin/frida-server"
        elif [ -f "build/subprojects/frida-core/server/frida-server" ]; then
          FRIDA_SERVER="build/subprojects/frida-core/server/frida-server"
        else
          # 使用 find 查找
          FRIDA_SERVER=$(find . -path "*/frida-server" -type f ! -path "*/.git/*" ! -path "*/build/tmp/*" | head -1)
        fi
        
        if [ -f "build/frida-android-arm64/bin/frida-inject" ]; then
          FRIDA_INJECT="build/frida-android-arm64/bin/frida-inject"
        elif [ -f "build/subprojects/frida-core/inject/frida-inject" ]; then
          FRIDA_INJECT="build/subprojects/frida-core/inject/frida-inject"
        else
          FRIDA_INJECT=$(find . -path "*/frida-inject" -type f ! -path "*/.git/*" ! -path "*/build/tmp/*" | head -1)
        fi
        
        if [ -f "build/frida-android-arm64/lib/frida/64/frida-gadget.so" ]; then
          FRIDA_GADGET="build/frida-android-arm64/lib/frida/64/frida-gadget.so"
        elif [ -f "build/subprojects/frida-core/lib/gadget/frida-gadget.so" ]; then
          FRIDA_GADGET="build/subprojects/frida-core/lib/gadget/frida-gadget.so"
        else
          FRIDA_GADGET=$(find . -path "*/frida-gadget.so" -type f ! -path "*/.git/*" ! -path "*/build/tmp/*" | head -1)
        fi
        
        # 显示找到的文件
        echo "Found files:"
        echo "  FRIDA_SERVER: $FRIDA_SERVER"
        echo "  FRIDA_INJECT: $FRIDA_INJECT"
        echo "  FRIDA_GADGET: $FRIDA_GADGET"
        
        # 验证文件存在并压缩
        if [ -n "$FRIDA_SERVER" ] && [ -f "$FRIDA_SERVER" ]; then
          echo "Compressing frida-server..."
          gzip -f "$FRIDA_SERVER"
          # 使用相对于工作区根目录的路径
          echo "FRIDA_SERVER_PATH=frida/${FRIDA_SERVER}.gz" >> $GITHUB_ENV
          echo "✅ frida-server compressed: frida/${FRIDA_SERVER}.gz"
        else
          echo "❌ frida-server not found"
          ls -la build/frida-android-arm64/bin/ 2>/dev/null || true
          ls -la build/subprojects/frida-core/server/ 2>/dev/null || true
        fi
        
        if [ -n "$FRIDA_INJECT" ] && [ -f "$FRIDA_INJECT" ]; then
          echo "Compressing frida-inject..."
          gzip -f "$FRIDA_INJECT"
          echo "FRIDA_INJECT_PATH=frida/${FRIDA_INJECT}.gz" >> $GITHUB_ENV
          echo "✅ frida-inject compressed: frida/${FRIDA_INJECT}.gz"
        else
          echo "❌ frida-inject not found"
        fi
        
        if [ -n "$FRIDA_GADGET" ] && [ -f "$FRIDA_GADGET" ]; then
          echo "Compressing frida-gadget..."
          gzip -f "$FRIDA_GADGET"
          echo "FRIDA_GADGET_PATH=frida/${FRIDA_GADGET}.gz" >> $GITHUB_ENV
          echo "✅ frida-gadget compressed: frida/${FRIDA_GADGET}.gz"
        else
          echo "❌ frida-gadget not found"
        fi
        
    - name: Upload frida-server
      uses: actions/upload-artifact@v4
      if: env.FRIDA_SERVER_PATH != ''
      with:
        name: frida-server-17.5.2-android-arm64
        path: ${{ env.FRIDA_SERVER_PATH }}
        
    - name: Upload frida-inject
      uses: actions/upload-artifact@v4
      if: env.FRIDA_INJECT_PATH != ''
      with:
        name: frida-inject-17.5.2-android-arm64
        path: ${{ env.FRIDA_INJECT_PATH }}
        
    - name: Upload frida-gadget
      uses: actions/upload-artifact@v4
      if: env.FRIDA_GADGET_PATH != ''
      with:
        name: frida-gadget-17.5.2-android-arm64
        path: ${{ env.FRIDA_GADGET_PATH }}
